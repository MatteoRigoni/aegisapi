@inherits LayoutComponentBase
@implements IDisposable
@using MudBlazor
@using Microsoft.Extensions.Configuration

@inject MudThemeManager ThemeManager
@inject IBreakpointService BreakpointService

<MudThemeProvider Theme="@ThemeManager.CurrentTheme" IsDarkMode="@ThemeManager.IsDarkMode" />
<MudDialogProvider />
<MudSnackbarProvider />

<div tabindex="0" @onkeydown="HandleKey" @onkeydown:preventDefault="true" @onkeydown:stopPropagation="true">
    <MudLayout>
        <MudAppBar Color="Color.Primary">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Class="hamburger-icon" OnClick="ToggleNavMenu" />
            <span class="cursive-title">Aegis Dashboard</span>
            <MudSpacer />
            <MudIconButton Icon="@(ThemeManager.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" Color="Color.Inherit" OnClick="ToggleTheme" />
            <MudChip Color="Color.Error" Variant="Variant.Filled">ALPHA</MudChip>
        </MudAppBar>
        <MudDrawerContainer>
            <MudDrawer @bind-Open="isNavMenuOpen" ClipMode="DrawerClipMode.Never" Variant="DrawerVariant.Responsive" MiniVariant="DrawerVariant.Mini" Breakpoint="Breakpoint.Md">
                <NavMenu />
            </MudDrawer>
            <MudMainContent Class="app-background mud-main-content">
                @Body
            </MudMainContent>
        </MudDrawerContainer>
    </MudLayout>
    @if (UseMocks)
    {
        <div class="mock-banner">MOCK MODE</div>
    }
</div>

@code {
    [Inject] NavigationManager Nav { get; set; } = default!;
    [Inject] IConfiguration Configuration { get; set; } = default!;
    [Inject] IDialogService Dialog { get; set; } = default!;

    private bool UseMocks => Configuration.GetValue<bool>("UseMocks");
    private bool isNavMenuOpen;
    private IDisposable? breakpointSubscription;

    protected override async Task OnInitializedAsync()
    {
        var breakpoint = await BreakpointService.GetBreakpoint();
        isNavMenuOpen = breakpoint >= Breakpoint.Md;
        breakpointSubscription = BreakpointService.Subscribe(bp =>
        {
            isNavMenuOpen = bp >= Breakpoint.Md;
            InvokeAsync(StateHasChanged);
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeManager.InitializeAsync();
            StateHasChanged();
        }
    }

    private async Task ToggleTheme()
    {
        await ThemeManager.ToggleThemeAsync();
        StateHasChanged();
    }

    private void ToggleNavMenu()
    {
        isNavMenuOpen = !isNavMenuOpen;
    }

    private void HandleKey(KeyboardEventArgs e)
    {
        if ((e.CtrlKey || e.MetaKey) && e.Key.Equals("k", StringComparison.OrdinalIgnoreCase))
        {
            OpenCommandPalette();
            return;
        }

        switch (e.Key.ToLowerInvariant())
        {
            case "d":
                Nav.NavigateTo("/");
                break;
            case "i":
                Nav.NavigateTo("/incidents");
                break;
            case "p":
                Nav.NavigateTo("/policies");
                break;
        }
    }

    private void OpenCommandPalette()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            DisableBackdropClick = true
        };

        Dialog.Show<SearchDialog>("Command Palette", options);
    }

    public void Dispose()
    {
        breakpointSubscription?.Dispose();
    }
}
