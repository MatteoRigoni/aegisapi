@page "/policies"
@using System.Text.Json
@inject IControlPlaneService ControlService
@inject ISnackbar Snackbar

<MonacoEditor @ref="editor" @bind-Value="policy" ConstructionOptions="editorOptions" Height="300px" Class="ma-2" />
<MudButton OnClick="Validate" Color="Color.Primary">Validate</MudButton>
<MudButton OnClick="Format" Color="Color.Secondary">Format</MudButton>
<MudButton OnClick="Save" Color="Color.Success">Save</MudButton>
<MudButton OnClick="SuggestPatch" Color="Color.Info">Suggerisci patch</MudButton>

@code {
    private MonacoEditor? editor;
    private string policy = "{}";
    private StandaloneEditorConstructionOptions editorOptions = new()
    {
        Language = "json",
        AutomaticLayout = true
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            policy = await ControlService.LoadPolicyAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
    }

    private void Validate()
    {
        try
        {
            using var doc = JsonDocument.Parse(policy);
            Snackbar.Add("Policy valid", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Invalid JSON", Severity.Error);
        }
    }

    private async Task Format()
    {
        try
        {
            if (editor is not null)
            {
                await editor.Trigger("keyboard", "editor.action.formatDocument", default(JsonElement));
                policy = await editor.GetValue();
            }
        }
        catch
        {
            Snackbar.Add("Invalid JSON", Severity.Error);
        }
    }

    private async Task Save()
    {
        try
        {
            if (editor is not null)
                policy = await editor.GetValue();
            await ControlService.SavePolicyAsync(policy);
            Snackbar.Add("Policy saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
    }

    private async Task SuggestPatch()
    {
        try
        {
            if (editor is not null)
                policy = await editor.GetValue();
            policy = await ControlService.SuggestPolicyPatchAsync(policy);
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
    }
}
