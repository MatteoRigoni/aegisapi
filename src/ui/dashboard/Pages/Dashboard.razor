@page "/"
@inject IMetricsService MetricsService
@inject ISnackbar Snackbar

<h3>Live Metrics</h3>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h6">CPU: @cpu.ToString("F1")%</MudText>
    <MudText Typo="Typo.h6">Memory: @memory.ToString("F0") MB</MudText>
    <MudText Typo="Typo.h6">Requests: @requests</MudText>
</MudPaper>

@code {
    private double cpu;
    private double memory;
    private int requests;
    private CancellationTokenSource? cts;

    protected override async Task OnInitializedAsync()
    {
        cts = new();
        try
        {
            await MetricsService.StartMetricsAsync(OnMetric, cts.Token);
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
        }
    }

    private Task OnMetric(MetricDto m)
    {
        cpu = m.Cpu;
        memory = m.Memory;
        requests = m.Requests;
        InvokeAsync(StateHasChanged);
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        cts?.Cancel();
    }
}
