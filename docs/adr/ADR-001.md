# ADR-001: Gateway Choice — YARP over Envoy

## Context
We need a high-performance reverse proxy/gateway tightly integrated with ASP.NET Core, enabling custom middlewares (authN/Z, schema validation), first-class .NET telemetry, and simple deployment. Alternatives include Envoy (C++), NGINX, and API Management services.

## Decision
Adopt **YARP (Yet Another Reverse Proxy)** on **.NET 8** as the in-process gateway. Extend via ASP.NET middleware for OIDC/JWT, OPA authZ, rate limiting, and schema/WAF checks. Use Azure Front Door/AppGW WAF at edge.

## Alternatives
- **Envoy**: rich L7 features, xDS, WASM. Heavier ops, extra language boundary for custom logic; steeper learning for team.
- NGINX: mature, less native gRPC/OTel/Rego integration for .NET.
- Fully managed API gateways: faster start, but limited policy control and higher lock-in.

## Consequences
- **Positive**: Rapid iteration in C#; consistent DI/logging; tight OTel integration; fewer moving parts.
- **Negative**: Smaller ecosystem vs Envoy; fewer off-the-shelf filters; need to build/polish middlewares.

## Security Impact
- In-proc model reduces hop surface; must harden Kestrel/TLS and ensure fail-closed on middleware errors.
- WAF largely handled at managed edge (AFD/AppGW). Optional in-proc Coraza for additional defense.

## Assumptions
- .NET skillset is core to the team; performance goals met by Kestrel/YARP.
- Edge WAF available.

## Trade-offs
- Losing Envoy’s xDS dynamic config; we compensate with GitOps & hot-reload in YARP.
- Custom code surface increases; offset by rigorous CI/CD and security scanning.

## Acceptance Criteria
- Gateway handles ≥ **10k RPS** p95 < **20ms** overhead in perf tests (k6).
- Middleware chain enforces authZ/limits/schemachecks; ZAP baseline scan shows **no high** findings.
